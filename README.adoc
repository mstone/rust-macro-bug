= rust macro bug
v0.1, 2023-01-03
Michael Stone
:homepage: https://github.com/mstone/rust-macro-bug
:sectlinks:
:icons: font

== Introduction

This repo is a minimal reproducer for a bug that I'm trying to track down.

The proc-macro that exhibits the bug is

[source,rust]
----
#![feature(proc_macro_span)]
use quote::{ToTokens};
use syn::{parse_macro_input, Item, Expr, visit_mut::VisitMut};

struct Parts {}

impl<'ast> VisitMut for Parts {
    fn visit_expr_mut(&mut self, expr: &mut Expr) {
        syn::visit_mut::visit_expr_mut(self, expr);

        let expr_clone = expr.clone();
        *expr = syn::Expr::Block(syn::ExprBlock{
            attrs: vec![],
            label: None,
            block: syn::Block{
                brace_token: syn::token::Brace::default(),
                stmts: vec![syn::Stmt::Expr(expr_clone)],
            },
        });
    }
}

#[proc_macro_attribute]
pub fn bug(args: proc_macro::TokenStream, input: proc_macro::TokenStream) -> proc_macro::TokenStream {
    let _ = args;
    let mut input = parse_macro_input!(input as Item);

    let mut parts = Parts{};
    parts.visit_item_mut(&mut input);
    
    let tokens = input.into_token_stream();
    tokens.into()
}
----

== Steps to reproduce

[source,bash]
----
nix develop
cargo test # fails to compile
----

The bug is visible at expansion-time by running:

[source,bash]
----
cargo expand --ugly --test 01-bug
----

which produces a surprise `(/\*ERROR*/)` where there should be a `{ b }` sub-expression, see callout (1) below:

[source,rust]
----
...
fn add(a: u64, b: u64) -> u64 { { { a } (/*ERROR*/) } } // <1>
...
----

<1> What is printing `(/\*ERROR*/)` here? -- This should be `{ b }` -- why isn't it?


== Expected Behavior

[source,bash]
----
cargo test
----

should succeed, and 

[source,bash]
----
cargo expand --ugly --test 01-bug 2>/dev/null | grep 'fn add'
----

should produce as output:

----
fn add(a: u64, b: u64) -> u64 { { { a } { b } } }
----

